machine:
  services:
    - docker
  node:
    version: 6.1.0

dependencies:
  pre:
# all
    - git diff-tree --no-commit-id --name-only -r ${CIRCLE_SHA1}
# backend
    - docker pull metahelicase/gradle:3.1
    - deployment/rancher/scripts/install-rancher-compose.sh
    - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --version
  override:
#backend
    - docker run --rm -v `pwd`:/project --workdir /project/backend -u `id -u`:`id -g` metahelicase/gradle:3.1 --no-daemon --console plain build
# frontend
    - npm install:
        pwd: frontend-web
  cache_directories:
    - backend/.gradle
    - tools
    - frontend-web/node_modules

test:
  override:
#backend
    - docker run --rm -v `pwd`:/project --workdir /project/backend -u `id -u`:`id -g` metahelicase/gradle:3.1 --no-daemon --console plain writeProjectVersion
    - echo "found version $(cat backend/build/version.txt)"
    - docker build --rm=false -t zenika/lunchplace_backend:ci-$(cat backend/build/version.txt) backend/
#frontend
    - npm run build --env=dev:
        pwd: frontend-web
    - docker build --rm=false -t zenika/lunchplace_frontend:ci-000 frontend-web
  post:
#common
    - docker login -e infos-lille@zenika.com -u $DOCKER_USER -p $DOCKER_PASS
#backend
    - docker tag zenika/lunchplace_backend:ci-$(cat backend/build/version.txt) zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
    - docker push zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
    - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --force-upgrade --pull -d backend:
      pwd: deployment/rancher/envs/lunchplace-staging
    - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --confirm-upgrade -d backend:
      pwd: deployment/rancher/envs/lunchplace-staging
#frontend
    - docker tag zenika/lunchplace_frontend:ci-000 zenika/lunchplace_frontend:develop-x
    - docker push zenika/lunchplace_frontend:develop-x

deployment:
  develop:
    branch: develop
    commands:
#common
      - docker login -e infos-lille@zenika.com -u $DOCKER_USER -p $DOCKER_PASS
#backend
      - docker tag zenika/lunchplace_backend:ci-$(cat backend/build/version.txt) zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
      - docker push zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
      - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --force-upgrade --pull -d backend:
        pwd: deployment/rancher/envs/lunchplace-staging
      - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --confirm-upgrade -d backend:
        pwd: deployment/rancher/envs/lunchplace-staging
#frontend
      - docker tag zenika/lunchplace_frontend:ci-000 zenika/lunchplace_frontend:develop-x
      - docker push zenika/lunchplace_frontend:develop-x
  master:
    branch: master
    commands:
      - echo "wip"
