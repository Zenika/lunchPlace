machine:
  services:
    - docker
  node:
    version: 6.1.0


dependencies:
  pre:
    - bash scripts/ci/backend/dependencies--pre.sh
  override:
    - bash scripts/ci/backend/dependencies--override.sh
  cache_directories:
    - backend/.gradle
    - tools

test:
  override:
    - bash scripts/ci/backend/test--override.sh
  post:
    - bash scripts/ci/backend/test--post.sh

deployment:
  develop:
    branch: develop
    commands:
      - docker login -e infos-lille@zenika.com -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag zenika/lunchplace_backend:ci-$(cat backend/build/version.txt) zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
      - docker images
      - docker push zenika/lunchplace_backend:develop-$(cat backend/build/version.txt)
      - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --force-upgrade --pull -d backend:
         pwd: deployment/rancher/envs/lunchplace-staging
      - ${HOME}/${CIRCLE_PROJECT_REPONAME}/tools/rancher-compose --access-key $RANCHER_ACCESS_KEY --secret-key $RANCHER_SECRET_KEY --project-name lunchplace-staging up --confirm-upgrade -d backend:
         pwd: deployment/rancher/envs/lunchplace-staging
  master:
    branch: master
    commands:
      - docker login -e infos-lille@zenika.com -u $DOCKER_USER -p $DOCKER_PASS
      - docker build --rm=false -t zenika/lunchplace_backend:$(cat backend/build/version.txt) backend/
      - docker images
      - docker push zenika/lunchplace_backend:$(cat backend/build/version.txt)
